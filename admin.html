<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP SHOP Admin Panel - DEBUG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        #error-display { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; padding: 1rem; margin-top: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <nav class="bg-indigo-700 p-4 text-white shadow-md"><div class="container mx-auto flex justify-between items-center"><h1 class="text-2xl font-bold">LP SHOP Admin Panel</h1><button id="adminLogoutButton" class="bg-red-500 text-white font-bold py-2 px-4 rounded hidden">Logout</button></div></nav>
    <div class="container mx-auto p-6">
        <!-- ERROR DISPLAY DIV -->
        <div id="error-display" class="hidden"></div>

        <section id="admin-login-section" class="bg-white p-8 rounded-lg shadow-md mb-8 max-w-md mx-auto">
             <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Admin Login</h2>
            <form id="adminLoginForm" class="space-y-4"><input name="email" type="email" placeholder="Admin Email" required class="w-full p-3 border rounded-md"><input name="password" type="password" placeholder="Admin Password" required class="w-full p-3 border rounded-md"><button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-md">Login</button><p id="adminLoginError" class="text-red-500 text-sm mt-2 text-center h-4"></p></form>
        </section>
        <main id="admin-panel-content" class="hidden">
            <!-- Dashboard Content -->
        </main>
    </div>
    
    <script type="module">
        // --- THIS SCRIPT IS FOR DEBUGGING ONLY ---
        const errorDisplay = document.getElementById('error-display');
        
        // Global error handler to catch any uncaught exceptions
        window.onerror = function (message, source, lineno, colno, error) {
            errorDisplay.classList.remove('hidden');
            errorDisplay.innerHTML = `<strong>A critical error occurred:</strong><br>
                Message: ${message}<br>
                Source: ${source.split('/').pop()}<br>
                Line: ${lineno}, Column: ${colno}<br>
                Error Type: ${error ? error.name : 'N/A'}`;
            return true;
        };

        try {
            // All your regular code will be inside this try...catch block
            const loginSection = document.getElementById('admin-login-section');
            const panelContent = document.getElementById('admin-panel-content');
            const loginForm = document.getElementById('adminLoginForm');
            const loginError = document.getElementById('adminLoginError');

            loginSection.classList.remove('hidden'); // Ensure login is visible initially

            // Attempt to import and initialize Firebase
            const firebase = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js');
            const auth_fns = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js');
            const firestore_fns = await import('https://www.gstatic.com/firebasejs/10.14.1/firestore.js');
        
            const firebaseConfig = {
              apiKey: "AIzaSyDhXWZay8NJHcmszfYtx_QZ7v_nxG3ufGw",
              authDomain: "lpshop-2.firebaseapp.com",
              projectId: "lpshop-2",
              storageBucket: "lpshop-2.firebasestorage.app",
              messagingSenderId: "1060044569045",
              appId: "1:1060044569045:web:a7446d548160b822d2255c"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const auth = auth_fns.getAuth(app);
            const db = firestore_fns.getFirestore(app);

            const checkIsAdmin = async (user) => {
                if (!user) return false;
                const adminDocRef = firestore_fns.doc(db, 'admins', user.uid);
                const adminDoc = await firestore_fns.getDoc(adminDocRef);
                return adminDoc.exists();
            };

            auth_fns.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const isAdmin = await checkIsAdmin(user);
                    if (isAdmin) {
                        loginSection.classList.add('hidden');
                        panelContent.classList.remove('hidden');
                        panelContent.innerHTML = '<h1>Welcome, Admin!</h1><p>Dashboard is loading...</p>'; // Simplified dashboard
                    } else {
                        await auth_fns.signOut(auth);
                        loginError.textContent = 'Access Denied.';
                    }
                } else {
                    loginSection.classList.remove('hidden');
                    panelContent.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.textContent = 'Logging in...';
                const email = e.target.elements.email.value;
                const password = e.target.elements.password.value;
                try {
                    await auth_fns.signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = `Login failed: ${error.code}`;
                }
            });

        } catch (error) {
            // This will catch initialization errors
            errorDisplay.classList.remove('hidden');
            errorDisplay.innerHTML = `<strong>A script initialization error occurred:</strong><br>
                Message: ${error.message}<br>
                Stack: ${error.stack}`;
        }
    </script>
</body>
</html>
