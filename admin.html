<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --admin-bg: #1e272e;
            --admin-sidebar-bg: #2d3436;
            --admin-text: #ecf0f1;
            --admin-primary: #3498db;
            --content-bg: #f4f6f9;
            --card-bg: #ffffff;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body { margin: 0; font-family: Arial, sans-serif; background-color: var(--content-bg); }
        
        #admin-login-view {
            display: none; width: 100%; min-height: 100vh; justify-content: center; align-items: center; background-color: var(--admin-sidebar-bg);
        }
        .login-box {
            width: 90%; max-width: 400px; padding: 40px; background: var(--card-bg); border-radius: 8px; box-shadow: var(--box-shadow);
        }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .error-message { color: var(--danger-color); text-align: center; margin-top: 15px; display: none; }

        #admin-dashboard-view { display: none; }
        .admin-layout { display: flex; }
        .sidebar { width: 250px; background-color: var(--admin-sidebar-bg); color: var(--admin-text); min-height: 100vh; transition: width 0.3s; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; background-color: var(--admin-bg); font-size: 1.5rem; font-weight: bold; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav a { display: block; color: var(--admin-text); text-decoration: none; padding: 15px 20px; transition: background-color 0.3s; }
        .sidebar-nav a.active, .sidebar-nav a:hover { background-color: var(--admin-primary); }
        .sidebar-nav a i { margin-right: 10px; width: 20px; }
        #logout-btn { background: var(--danger-color); color: white; text-align: center; padding: 15px 20px; cursor: pointer; border: none; width: 100%; font-size: 1rem; }
        
        .main-content { flex-grow: 1; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        
        h2 { margin-bottom: 20px; }
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .stat-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: var(--box-shadow); }
        .stat-card h3 { margin-top: 0; }
        .stat-card .count { font-size: 2rem; font-weight: bold; }

        .data-table-wrapper { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: var(--card-bg); }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
        .data-table th { background-color: #f2f2f2; }
        .data-table img { max-width: 60px; border-radius: 4px; }
        .data-table small { color: #777; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; margin-right: 5px; text-decoration: none; display: inline-block; font-size: 1rem; }
        .btn-primary { background-color: var(--admin-primary); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-info { background-color: #17a2b8; }
        .btn-sm { font-size: 0.8rem; padding: 5px 10px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Order Details Modal Styling */
        #order-details-modal .modal-header { font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        #order-details-modal .detail-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; }
        #order-details-modal .detail-grid strong { text-align: right; color: #555;}
        #order-details-modal hr { margin: 15px 0; border: 0; border-top: 1px solid #eee; }
        #order-details-modal ul { list-style: none; padding: 0; }

        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar-header, .sidebar-nav .nav-text, #logout-btn .nav-text { display: none; }
            .sidebar-nav a { text-align: center; }
            .sidebar-nav a i { margin-right: 0; }
            #logout-btn i { margin: 0; }
        }
    </style>
</head>
<body>

    <div id="admin-login-view">
        <div class="login-box">
            <h2>Admin Panel Login</h2>
            <form id="login-form">
                <div class="form-group"><label for="admin-email">Email</label><input type="email" id="admin-email" required></div>
                <div class="form-group"><label for="admin-password">Password</label><input type="password" id="admin-password" required></div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p class="error-message" id="login-error"></p>
            </form>
        </div>
    </div>

    <div id="admin-dashboard-view">
        <div class="admin-layout">
            <aside class="sidebar">
                <div>
                    <div class="sidebar-header">Admin</div>
                    <nav class="sidebar-nav">
                        <a href="#dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i><span class="nav-text"> Dashboard</span></a>
                        <a href="#products" class="nav-link"><i class="fas fa-box"></i><span class="nav-text"> Products</span></a>
                        <a href="#orders" class="nav-link"><i class="fas fa-shopping-cart"></i><span class="nav-text"> Orders</span></a>
                        <a href="#slider" class="nav-link"><i class="fas fa-images"></i><span class="nav-text"> Slider</span></a>
                        <a href="#messages" class="nav-link"><i class="fas fa-envelope"></i><span class="nav-text"> Messages</span></a>
                    </nav>
                </div>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i><span class="nav-text"> Logout</span></button>
            </aside>
            <main id="admin-content" class="main-content">
                <section id="dashboard" class="page"></section>
                <section id="products" class="page"></section>
                <section id="orders" class="page"></section>
                <section id="slider" class="page"></section>
                <section id="messages" class="page"></section>
            </main>
        </div>
    </div>
    
    <div id="product-modal" class="modal"></div>
    <div id="slider-modal" class="modal"></div>
    <div id="order-details-modal" class="modal"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, remove, push, update, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCytFv4Mzvur0xr0_hJwRXhO7TvdSZP7Fg",
            authDomain: "lp-shop-63677.firebaseapp.com",
            databaseURL: "https://lp-shop-63677-default-rtdb.firebaseio.com",
            projectId: "lp-shop-63677",
            storageBucket: "lp-shop-63677.appspot.com",
            messagingSenderId: "695280150789",
            appId: "1:695280150789:web:a31cbbf60e79eb82b4ef6c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase();

        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.style.display = 'none';
                dashboardView.style.display = 'block';
                initializeDashboard();
            } else {
                dashboardView.style.display = 'none';
                loginView.style.display = 'flex';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.style.display = 'none';
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
            }
        });

        function initializeDashboard() {
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            const navigateTo = (hash) => {
                const pageId = hash ? hash.substring(1) : 'dashboard';
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                renderPageContent(pageId);
                document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.getAttribute('href') === `#${pageId}`));
            };

            window.addEventListener('hashchange', () => navigateTo(location.hash));
            document.querySelectorAll('.sidebar-nav a').forEach(l => l.addEventListener('click', (e) => {
                e.preventDefault();
                const targetHash = l.getAttribute('href');
                if (location.hash !== targetHash) {
                    history.pushState(null, '', targetHash);
                    navigateTo(targetHash);
                }
            }));

            const renderPageContent = (pageId) => {
                const page = document.getElementById(pageId);
                if (!page) return;
                switch(pageId) {
                    case 'dashboard': renderDashboard(page); break;
                    case 'products': renderProducts(page); break;
                    case 'orders': renderOrders(page); break;
                    case 'slider': renderSlider(page); break;
                    case 'messages': renderMessages(page); break;
                }
            };
            
            const renderDashboard = (page) => {
                page.innerHTML = `<h2>Dashboard</h2><div class="stat-cards"></div>`;
                const stats = { Products: 'products', Orders: 'orders', Users: 'users', Messages: 'messages' };
                const icons = { Products: 'fa-box', Orders: 'fa-shopping-cart', Users: 'fa-users', Messages: 'fa-envelope' };
                Object.entries(stats).forEach(([title, path]) => {
                    onValue(ref(db, path), (snap) => {
                        let count = 0;
                        if (snap.exists()) {
                            if (path === 'orders') {
                                Object.values(snap.val()).forEach(userOrders => count += Object.keys(userOrders).length);
                            } else {
                                count = Object.keys(snap.val()).length;
                            }
                        }
                        updateStatCard(page.querySelector('.stat-cards'), title, count, icons[title]);
                    });
                });
            };

            const updateStatCard = (container, title, count, icon) => {
                let card = container.querySelector(`#stat-${title.toLowerCase()}`);
                if (!card) {
                    card = document.createElement('div');
                    card.id = `stat-${title.toLowerCase()}`;
                    card.className = 'stat-card';
                    container.appendChild(card);
                }
                card.innerHTML = `<h3><i class="fas ${icon}"></i> ${title}</h3><div class="count">${count}</div>`;
            };

            const renderProducts = (page) => {
                page.innerHTML = `<h2>Product Management <button id="add-product-btn" class="btn btn-success" style="float: right;">Add Product</button></h2><div class="data-table-wrapper"><table class="data-table"><thead><tr><th>Image</th><th>Name</th><th>Category</th><th>Price</th><th>Actions</th></tr></thead><tbody id="products-table-body"></tbody></table></div>`;
                onValue(ref(db, 'products'), snap => {
                    const tbody = page.querySelector('#products-table-body');
                    tbody.innerHTML = '';
                    if(snap.exists()) {
                        snap.forEach(childSnap => {
                            const id = childSnap.key;
                            const p = childSnap.val();
                            tbody.innerHTML += `<tr><td><img src="${p.imageUrl}" alt="${p.name}"></td><td>${p.name}</td><td>${p.category}</td><td>$${p.price}</td><td><button class="btn btn-primary edit-product-btn" data-id="${id}">Edit</button><button class="btn btn-danger delete-product-btn" data-id="${id}">Delete</button></td></tr>`;
                        });
                    }
                });
            };
            
            const renderOrders = (page) => {
                page.innerHTML = `<h2>Order Management</h2><div class="data-table-wrapper"><table class="data-table"><thead><tr><th>ID</th><th>Customer</th><th>Date</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody id="orders-table-body"></tbody></table></div>`;
                const statuses = { 'Pending': 'ðŸ•’', 'Processing': 'âš™ï¸', 'Completed': 'âœ…', 'Cancelled': 'âŒ' };
                onValue(ref(db, 'orders'), snap => {
                    const tbody = page.querySelector('#orders-table-body');
                    tbody.innerHTML = '';
                    if(snap.exists()) {
                        snap.forEach(userSnap => {
                            const userId = userSnap.key;
                            userSnap.forEach(orderSnap => {
                                const orderId = orderSnap.key;
                                const o = orderSnap.val();
                                tbody.innerHTML += `<tr>
                                    <td>${orderId.slice(1, 7)}...</td>
                                    <td>${o.shippingName}<br><small>${o.userEmail}</small></td>
                                    <td>${new Date(o.date).toLocaleDateString()}</td>
                                    <td>$${o.totalAmount.toFixed(2)}</td>
                                    <td>
                                        <select class="status-dropdown" data-user-id="${userId}" data-order-id="${orderId}">
                                            ${Object.entries(statuses).map(([status, icon]) => `<option value="${status}" ${o.status === status ? 'selected' : ''}>${icon} ${status}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-sm view-order-details-btn" data-user-id="${userId}" data-order-id="${orderId}">View Details</button>
                                        <button class="btn btn-danger btn-sm delete-order-btn" data-user-id="${userId}" data-order-id="${orderId}">Delete</button>
                                    </td>
                                </tr>`;
                            });
                        });
                    }
                });
            };
            
            const renderSlider = (page) => {
                page.innerHTML = `<h2>Slider Management <button id="add-slider-btn" class="btn btn-success" style="float: right;">Add Image</button></h2><div class="data-table-wrapper"><table class="data-table"><thead><tr><th>Preview</th><th>URL</th><th>Actions</th></tr></thead><tbody id="slider-table-body"></tbody></table></div>`;
                onValue(ref(db, 'sliderImages'), snap => {
                    const tbody = page.querySelector('#slider-table-body');
                    tbody.innerHTML = '';
                    if (snap.exists()) {
                        snap.forEach(childSnap => {
                            const id = childSnap.key;
                            const { downloadURL } = childSnap.val();
                            tbody.innerHTML += `<tr><td><img src="${downloadURL}" alt="Slider"></td><td>${downloadURL}</td><td><button class="btn btn-danger delete-slider-btn" data-id="${id}">Delete</button></td></tr>`;
                        });
                    }
                });
            };

            const renderMessages = (page) => {
                page.innerHTML = `<h2>Messages</h2><div class="data-table-wrapper"><table class="data-table"><thead><tr><th>Date</th><th>Name</th><th>Email</th><th>Message</th></tr></thead><tbody id="messages-table-body"></tbody></table></div>`;
                onValue(ref(db, 'messages'), snap => {
                    const tbody = page.querySelector('#messages-table-body');
                    if(snap.exists()){
                        let messages = [];
                        snap.forEach(childSnap => messages.push(childSnap.val()));
                        tbody.innerHTML = messages.reverse().map(m => `<tr><td>${new Date(m.date).toLocaleString()}</td><td>${m.name}</td><td>${m.email}</td><td>${m.message}</td></tr>`).join('');
                    }
                });
            }

            const showProductModal = (product = {}, id = null) => {
                document.getElementById('product-modal').innerHTML = `<div class="modal-content"><h2>${id ? 'Edit' : 'Add'} Product</h2><form id="product-form" data-id="${id || ''}"><div class="form-group"><label>Name</label><input type="text" id="product-name" value="${product.name || ''}" required></div><div class="form-group"><label>Category</label><input type="text" id="product-category" value="${product.category || ''}" required></div><div class="form-group"><label>Price</label><input type="number" id="product-price" value="${product.price || ''}" required></div><div class="form-group"><label>Image URL</label><input type="url" id="product-imageUrl" value="${product.imageUrl || ''}" required></div><div class="form-group"><label>Description</label><textarea id="product-description">${product.description || ''}</textarea></div><button type="submit" class="btn btn-success">Save</button><button type="button" class="btn btn-danger close-modal-btn">Cancel</button></form></div>`;
                document.getElementById('product-modal').classList.add('active');
            };

            const showSliderModal = () => {
                document.getElementById('slider-modal').innerHTML = `<div class="modal-content"><h2>Add Slider Image</h2><form id="slider-form"><div class="form-group"><label>Image URL</label><input type="url" id="s
