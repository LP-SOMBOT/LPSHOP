<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a href="#" class="text-2xl font-bold text-blue-600">LP SHOP</a>
                <!-- Desktop Nav -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="#shop-section" class="text-gray-600 hover:text-blue-600 px-3 py-2">Shop</a>
                    <div id="auth-links-desktop" class="flex items-center space-x-2">
                        <a href="#auth-section" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-md">Login</a>
                        <a href="#auth-section" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Signup</a>
                    </div>
                    <div id="profile-dropdown-container" class="relative hidden">
                        <button id="profile-menu-button" class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                            <svg class="h-6 w-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="profile-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                            <div class="py-1"><div class="px-4 py-2 border-b"><p class="text-sm text-gray-500">Signed in as</p><p class="text-sm font-medium text-gray-900 truncate user-email-display"></p></div><a href="#" id="logout-button-desktop" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a></div>
                        </div>
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <div class="md:hidden"><button id="mobile-menu-button" class="text-gray-600 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden hidden px-2 pt-2 pb-4 space-y-1">
            <a href="#shop-section" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Shop</a>
            <div id="auth-links-mobile"><a href="#auth-section" class="block bg-blue-500 text-white text-center mt-2 px-4 py-2 rounded-md">Login / Signup</a></div>
            <div id="profile-info-mobile" class="hidden border-t pt-4 mt-4">
                <p class="px-3 text-sm text-gray-500">Signed in as</p><p class="px-3 font-medium user-email-display"></p>
                <a href="#" id="logout-button-mobile" class="block mt-2 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Sign out</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 mt-8">
        <section id="auth-section" class="max-w-md mx-auto">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="mb-6 border-b"><nav class="-mb-px flex space-x-6"><button id="login-tab" class="py-4 px-1 border-b-2 tab-active">Login</button><button id="signup-tab" class="py-4 px-1 border-b-2 border-transparent text-gray-500">Signup</button></nav></div>
                <div id="login-form-container">
                    <h2 class="text-2xl font-bold mb-4">Login</h2><form id="loginForm" class="space-y-4"><input type="email" id="loginEmail" placeholder="Email" required class="w-full p-3 bg-gray-100 rounded-lg"><input type="password" id="loginPassword" placeholder="Password" required class="w-full p-3 bg-gray-100 rounded-lg"><button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold">Login</button><p id="loginError" class="text-red-500 text-sm text-center h-4"></p></form>
                </div>
                <div id="signup-form-container" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Create Account</h2><form id="signupForm" class="space-y-4"><input type="email" id="signupEmail" placeholder="Email" required class="w-full p-3 bg-gray-100 rounded-lg"><input type="password" id="signupPassword" placeholder="Password (min. 6 chars)" required class="w-full p-3 bg-gray-100 rounded-lg"><button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold">Signup</button><p id="signupError" class="text-red-500 text-sm text-center h-4"></p></form>
                </div>
            </div>
        </section>

        <section id="logged-in-content" class="hidden">
            <div id="shop-section">
                <div class="text-center mb-12"><h2 class="text-4xl font-bold">Our Products</h2></div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
            </div>
            <div id="orders-section" class="mt-20">
                <div class="text-center mb-12"><h2 class="text-3xl font-bold">My Order History</h2></div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full">
                        <thead><tr><th class="py-2 px-4 text-left">Product</th><th class="py-2 px-4 text-left">Date</th><th class="py-2 px-4 text-left">Price</th><th class="py-2 px-4 text-left">Status</th></tr></thead>
                        <tbody id="order-history-list" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, addDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        const firebaseConfig = { apiKey: 'AIzaSyA2Y1NmbEdDYRNCooSmf6rcdBdeWg3D9Hg', authDomain: 'lpshop-c8fe6.firebaseapp.com', projectId: 'lpshop-c8fe6', storageBucket: 'lpshop-c8fe6.firebasestorage.app', messagingSenderId: '307849631006', appId: '1:307849631006:web:460e06f55a689b19eda50f' };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const loggedInContent = document.getElementById('logged-in-content');
        const productListDiv = document.getElementById('product-list');
        const orderHistoryList = document.getElementById('order-history-list');
        const authLinksDesktop = document.getElementById('auth-links-desktop');
        const authLinksMobile = document.getElementById('auth-links-mobile');
        const profileDropdownContainer = document.getElementById('profile-dropdown-container');
        const profileInfoMobile = document.getElementById('profile-info-mobile');
        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileMenu = document.getElementById('profile-menu');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const logoutButtonDesktop = document.getElementById('logout-button-desktop');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');
        const userEmailDisplays = document.querySelectorAll('.user-email-display');
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginError = document.getElementById('loginError');
        const signupError = document.getElementById('signupError');

        let productsData = [];

        onAuthStateChanged(auth, user => {
            if (user) {
                authSection.classList.add('hidden'); loggedInContent.classList.remove('hidden');
                authLinksDesktop.classList.add('hidden'); authLinksMobile.classList.add('hidden');
                profileDropdownContainer.classList.remove('hidden'); profileInfoMobile.classList.remove('hidden');
                userEmailDisplays.forEach(el => el.textContent = user.email);
                fetchProducts();
                fetchUserOrders(user.uid);
            } else {
                loggedInContent.classList.add('hidden'); authSection.classList.remove('hidden');
                authLinksDesktop.classList.remove('hidden'); authLinksMobile.classList.remove('hidden');
                profileDropdownContainer.classList.add('hidden'); profileInfoMobile.classList.add('hidden');
                productListDiv.innerHTML = '';
            }
        });

        const handleBuyNow = async (productId) => {
            const product = productsData.find(p => p.id === productId);
            if (!product || !auth.currentUser) return;
            if (!confirm(`Pay $${product.price.toFixed(2)} for ${product.name}?\nThis will open your phone dialer.`)) return;
            try {
                await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid, userEmail: auth.currentUser.email,
                    productId: product.id, productName: product.name, price: product.price,
                    diamonds: product.diamonds, imageUrl: product.imageUrl,
                    status: "Pending", orderDate: serverTimestamp()
                });
                const ussdCode = `*712*613982172*${product.price}#`;
                window.location.href = `tel:${encodeURIComponent(ussdCode)}`;
            } catch (error) { console.error("Error creating order: ", error); alert("Could not place order. Check console for errors."); }
        };
        
        productListDiv.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('buy-now-btn')) handleBuyNow(e.target.dataset.id);
        });

        const fetchProducts = async () => {
            productsData = [];
            productListDiv.innerHTML = '<p class="col-span-full text-center">Loading products...</p>';
            const q = query(collection(db, "products"), orderBy("name"));
            const querySnapshot = await getDocs(q);
            productListDiv.innerHTML = '';
            if(querySnapshot.empty) {
                productListDiv.innerHTML = `<p class="col-span-full text-center">No products found.</p>`;
            } else {
                querySnapshot.forEach((doc) => {
                    const product = { ...doc.data(), id: doc.id };
                    productsData.push(product);
                    productListDiv.innerHTML += `
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-all">
                            <img class="h-64 w-full object-cover" src="${product.imageUrl}" alt="${product.name}">
                            <div class="p-6">
                                <h3 class="text-xl font-semibold mb-2">${product.name}</h3>
                                <p class="text-sm font-bold text-teal-500 mb-2">♦️ ${product.diamonds || 0} Diamonds</p>
                                <p class="text-2xl font-bold mb-4">$${product.price.toFixed(2)}</p>
                                <button data-id="${product.id}" class="buy-now-btn w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Buy Now</button>
                            </div>
                        </div>`;
                });
            }
        };

        const fetchUserOrders = (userId) => {
            const q = query(collection(db, "orders"), where("userId", "==", userId), orderBy("orderDate", "desc"));
            onSnapshot(q, (snapshot) => {
                orderHistoryList.innerHTML = "";
                if (snapshot.empty) { orderHistoryList.innerHTML = '<tr><td colspan="4" class="p-4 text-center">No orders yet.</td></tr>'; return; }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const date = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleDateString() : '...';
                    let s = { 'Pending': 'bg-yellow-100 text-yellow-800', 'Completed': 'bg-green-100 text-green-800', 'Rejected': 'bg-red-100 text-red-800' }[order.status] || '';
                    orderHistoryList.innerHTML += `<tr><td class="p-4 font-medium">${order.productName}</td><td class="p-4">${date}</td><td class="p-4">$${order.price.toFixed(2)}</td><td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${s}">${order.status}</span></td></tr>`;
                });
            }, (error) => {
                console.error("Error fetching user orders: ", error);
                orderHistoryList.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error loading orders. A database index may be required.</td></tr>`;
            });
        };

        profileMenuButton.addEventListener('click', () => profileMenu.classList.toggle('hidden'));
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        loginTab.addEventListener('click', () => { signupFormContainer.classList.add('hidden'); loginFormContainer.classList.remove('hidden'); loginTab.classList.add('tab-active'); signupTab.classList.remove('tab-active'); });
        signupTab.addEventListener('click', () => { loginFormContainer.classList.add('hidden'); signupFormContainer.classList.remove('hidden'); signupTab.classList.add('tab-active'); loginTab.classList.remove('tab-active'); });
        loginForm.addEventListener('submit', async e => { e.preventDefault(); loginError.textContent=''; try { await signInWithEmailAndPassword(auth, loginForm.loginEmail.value, loginForm.loginPassword.value); } catch (err) { loginError.textContent = err.message; }});
        signupForm.addEventListener('submit', async e => { e.preventDefault(); signupError.textContent=''; try { await createUserWithEmailAndPassword(auth, signupForm.signupEmail.value, signupForm.signupPassword.value); } catch (err) { signupError.textContent = err.message; }});
        const handleLogout = () => signOut(auth);
        logoutButtonDesktop.addEventListener('click', handleLogout);
        logoutButtonMobile.addEventListener('click', handleLogout);
    </script>
</body>
                                                                                                                       </html>
