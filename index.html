<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { transition: all 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a href="#" class="text-2xl font-bold text-blue-600">LP SHOP</a>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="#shop-section" class="text-gray-600 hover:text-blue-600 px-3 py-2">Shop</a>
                    <div id="auth-links-desktop" class="flex items-center space-x-2">
                        <a href="#auth-section" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-md">Login</a>
                        <a href="#auth-section" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Signup</a>
                    </div>
                    <div id="profile-dropdown-container" class="relative hidden">
                        <button id="profile-menu-button" class="bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center">
                            <svg class="h-6 w-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="profile-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                            <div class="py-1"><div class="px-4 py-2 border-b"><p class="text-sm text-gray-500">Signed in as</p><p class="text-sm font-medium text-gray-900 truncate user-email-display"></p></div><a href="#" id="logout-button-desktop" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a></div>
                        </div>
                    </div>
                </div>
                <div class="md:hidden"><button id="mobile-menu-button" class="text-gray-600 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div>
            </div>
        </div>
        <div id="mobile-menu" class="md:hidden hidden px-2 pt-2 pb-4 space-y-1">
            <a href="#shop-section" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Shop</a>
            <div id="auth-links-mobile"><a href="#auth-section" class="block bg-blue-500 text-white text-center mt-2 px-4 py-2 rounded-md">Login / Signup</a></div>
            <div id="profile-info-mobile" class="hidden border-t pt-4 mt-4">
                <p class="px-3 text-sm text-gray-500">Signed in as</p><p class="px-3 font-medium user-email-display"></p>
                <a href="#" id="logout-button-mobile" class="block mt-2 px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Sign out</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 mt-8 min-h-screen">
        <section id="auth-section" class="max-w-md mx-auto">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="mb-6 border-b"><nav class="-mb-px flex space-x-6"><button id="login-tab" class="py-4 px-1 border-b-2 tab-active">Login</button><button id="signup-tab" class="py-4 px-1 border-b-2 border-transparent text-gray-500">Signup</button></nav></div>
                <div id="login-form-container">
                    <h2 class="text-2xl font-bold mb-4">Login</h2><form id="loginForm" class="space-y-4"><input type="email" id="loginEmail" placeholder="Email" required class="w-full p-3 bg-gray-100 rounded-lg"><input type="password" id="loginPassword" placeholder="Password" required class="w-full p-3 bg-gray-100 rounded-lg"><button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold">Login</button></form>
                    <div class="text-center mt-4"><a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:underline">Forgot Password?</a></div>
                </div>
                <div id="signup-form-container" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Create Account</h2><form id="signupForm" class="space-y-4"><input type="email" id="signupEmail" placeholder="Email" required class="w-full p-3 bg-gray-100 rounded-lg"><input type="password" id="signupPassword" placeholder="Password (min. 6 chars)" required class="w-full p-3 bg-gray-100 rounded-lg"><button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold">Signup</button></form>
                </div>
            </div>
        </section>

        <section id="logged-in-content" class="hidden">
            <div id="shop-section">
                <div class="text-center mb-8"><h2 class="text-4xl font-bold">Our Products</h2></div>
                <div class="mb-8 max-w-lg mx-auto"><input type="text" id="search-bar" placeholder="🔍 Search for a product..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
            </div>
            <div id="orders-section" class="mt-20">
                <div class="text-center mb-12"><h2 class="text-3xl font-bold">My Order History</h2></div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full">
                        <thead><tr><th class="py-2 px-4 text-left">Product</th><th class="py-2 px-4 text-left">Date</th><th class="py-2 px-4 text-left">Price</th><th class="py-2 px-4 text-left">Status</th></tr></thead>
                        <tbody id="order-history-list" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6 text-center transform modal-content scale-95 opacity-0">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3><div id="modal-body" class="text-gray-600 mb-6"></div><div id="modal-footer" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <a href="https://wa.me/16042397558" target="_blank" class="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.894-9.89-9.894-5.454 0-9.888 4.434-9.888 9.894 0 2.094.615 4.135 1.734 5.947l.189.311-1.223 4.479 4.625-1.214.335.2a11.36 11.36 0 0 0 5.52.418zM8.311 10.371c.213-.104.456-.157.698-.157.25.002.49.06.702.169l.432.215c.224.112.384.281.473.491.079.183.111.387.092.585-.024.237-.112.463-.255.655-.144.194-.325.352-.527.472l-.248.15c-.15.09-.27.208-.352.347-.116.195-.164.417-.152.636.042.548.223.972.454 1.265.312.404.708.71 1.163.916.194.088.403.136.613.137.244 0 .484-.066.696-.193l.34-.205c.189-.115.409-.17.629-.16.25.011.492.083.702.212l1.623.955c.31.181.54.444.66.758.12.315.111.662-.024.968-.219.491-.56.891-1.002 1.187-.442.296-.943.465-1.462.515-1.163.116-2.293-.176-3.298-.84-1.441-.954-2.583-2.39-3.295-4.045-.095-.224-.149-.462-.16-.704-.005-.15.025-.298.087-.436.142-.315.383-.558.683-.711l.157-.08Z"/></svg>
    </a>

    <footer class="bg-white mt-16 py-6 border-t"><div class="container mx-auto text-center text-gray-600"><p>&copy; 2024 LP SHOP. All rights reserved.</p></div></footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, addDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        const firebaseConfig = { apiKey: 'AIzaSyA2Y1NmbEdDYRNCooSmf6rcdBdeWg3D9Hg', authDomain: 'lpshop-c8fe6.firebaseapp.com', projectId: 'lpshop-c8fe6', storageBucket: 'lpshop-c8fe6.firebasestorage.app', messagingSenderId: '307849631006', appId: '1:307849631006:web:460e06f55a689b19eda50f' };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const allDOMElements = {
            authSection: document.getElementById('auth-section'), loggedInContent: document.getElementById('logged-in-content'),
            productListDiv: document.getElementById('product-list'), orderHistoryList: document.getElementById('order-history-list'),
            searchBar: document.getElementById('search-bar'), forgotPasswordLink: document.getElementById('forgot-password-link'),
            modal: document.getElementById('modal'), modalContent: document.getElementById('modal-content'),
            modalTitle: document.getElementById('modal-title'), modalBody: document.getElementById('modal-body'),
            modalFooter: document.getElementById('modal-footer'), authLinksDesktop: document.getElementById('auth-links-desktop'),
            authLinksMobile: document.getElementById('auth-links-mobile'), profileDropdownContainer: document.getElementById('profile-dropdown-container'),
            profileInfoMobile: document.getElementById('profile-info-mobile'), profileMenuButton: document.getElementById('profile-menu-button'),
            profileMenu: document.getElementById('profile-menu'), mobileMenuButton: document.getElementById('mobile-menu-button'),
            mobileMenu: document.getElementById('mobile-menu'), logoutButtonDesktop: document.getElementById('logout-button-desktop'),
            logoutButtonMobile: document.getElementById('logout-button-mobile'), userEmailDisplays: document.querySelectorAll('.user-email-display'),
            loginTab: document.getElementById('login-tab'), signupTab: document.getElementById('signup-tab'),
            loginFormContainer: document.getElementById('login-form-container'), signupFormContainer: document.getElementById('signup-form-container'),
            loginForm: document.getElementById('loginForm'), signupForm: document.getElementById('signupForm')
        };
        
        let productsData = [];

        const showModal = (title, body, buttons = []) => {
            allDOMElements.modalTitle.textContent = title; allDOMElements.modalBody.innerHTML = body; allDOMElements.modalFooter.innerHTML = '';
            if (buttons.length === 0) buttons.push({ text: 'Close', class: 'bg-gray-500', action: hideModal });
            buttons.forEach(btn => {
                const el = document.createElement('button');
                el.textContent = btn.text; el.className = `text-white px-6 py-2 rounded-lg ${btn.class}`; el.onclick = btn.action;
                allDOMElements.modalFooter.appendChild(el);
            });
            allDOMElements.modal.classList.remove('hidden');
            setTimeout(() => allDOMElements.modalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        const hideModal = () => {
            allDOMElements.modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => allDOMElements.modal.classList.add('hidden'), 300);
        };

        const updateNav = (user) => {
            const isLoggedIn = !!user;
            allDOMElements.authSection.classList.toggle('hidden', isLoggedIn);
            allDOMElements.loggedInContent.classList.toggle('hidden', !isLoggedIn);
            allDOMElements.authLinksDesktop.classList.toggle('hidden', isLoggedIn);
            allDOMElements.authLinksMobile.classList.toggle('hidden', isLoggedIn);
            allDOMElements.profileDropdownContainer.classList.toggle('hidden', !isLoggedIn);
            allDOMElements.profileInfoMobile.classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) allDOMElements.userEmailDisplays.forEach(el => el.textContent = user.email);
        };

        onAuthStateChanged(auth, user => {
            updateNav(user);
            if (user) { fetchProducts(); fetchUserOrders(user.uid); }
            else { allDOMElements.productListDiv.innerHTML = ''; productsData = []; }
        });

        const handleBuyNow = (productId) => {
            const product = productsData.find(p => p.id === productId);
            if (!product || !auth.currentUser) return;
            showModal('Confirm Purchase', `Pay <b>$${product.price.toFixed(2)}</b> for <b>${product.name}</b>?<br>This will open your phone dialer.`,
                [{ text: 'Cancel', class: 'bg-gray-500', action: hideModal },
                 { text: 'Proceed', class: 'bg-blue-600', action: async () => {
                    hideModal();
                    try {
                        await addDoc(collection(db, "orders"), {
                            userId: auth.currentUser.uid, userEmail: auth.currentUser.email,
                            productId: product.id, productName: product.name, price: product.price,
                            diamonds: product.diamonds, imageUrl: product.imageUrl,
                            status: "Pending", orderDate: serverTimestamp()
                        });
                        window.location.href = `tel:${encodeURIComponent(`*712*613982172*${product.price}#`)}`;
                    } catch (error) { showModal('Error', 'Could not place order.'); }
                 }}]
            );
        };
        
        const showProductDetails = (productId) => {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            showModal(product.name, `<img src="${product.imageUrl}" class="w-full h-64 object-cover rounded-lg mb-4"><p>${product.description || 'No details available.'}</p>`);
        };

        allDOMElements.productListDiv.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card'); if (!card) return;
            if (e.target.classList.contains('buy-now-btn')) handleBuyNow(card.dataset.id);
            else showProductDetails(card.dataset.id);
        });
        
        allDOMElements.searchBar.addEventListener('keyup', () => {
            const term = allDOMElements.searchBar.value.toLowerCase();
            document.querySelectorAll('.product-card').forEach(card => card.style.display = card.dataset.name.toLowerCase().includes(term) ? '' : 'none');
        });

        const fetchProducts = async () => {
            productsData = [];
            allDOMElements.productListDiv.innerHTML = `<p class="col-span-full text-center">Loading...</p>`;
            const q = query(collection(db, "products"), orderBy("name"));
            const snapshot = await getDocs(q);
            allDOMElements.productListDiv.innerHTML = '';
            if(snapshot.empty) allDOMElements.productListDiv.innerHTML = `<p class="col-span-full text-center">No products found.</p>`;
            else snapshot.forEach(doc => {
                const p = { ...doc.data(), id: doc.id };
                productsData.push(p);
                allDOMElements.productListDiv.innerHTML += `
                    <div class="product-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer" data-id="${p.id}" data-name="${p.name}">
                        <img class="h-64 w-full object-cover pointer-events-none" src="${p.imageUrl}" alt="${p.name}">
                        <div class="p-6 pointer-events-none"><h3 class="text-xl font-semibold">${p.name}</h3><p class="text-sm font-bold text-teal-500 my-2">♦️ ${p.diamonds || 0}</p><p class="text-2xl font-bold mb-4">$${p.price.toFixed(2)}</p></div>
                        <div class="p-4 pt-0"><button class="buy-now-btn w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Buy Now</button></div>
                    </div>`;
            });
        };

        const fetchUserOrders = (userId) => {
            const q = query(collection(db, "orders"), where("userId", "==", userId), orderBy("orderDate", "desc"));
            onSnapshot(q, (snapshot) => {
                allDOMElements.orderHistoryList.innerHTML = "";
                if (snapshot.empty) { allDOMElements.orderHistoryList.innerHTML = '<tr><td colspan="4" class="p-4 text-center">No orders yet.</td></tr>'; return; }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const date = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleDateString() : '...';
                    let s = { 'Pending': 'bg-yellow-100 text-yellow-800', 'Completed': 'bg-green-100 text-green-800', 'Rejected': 'bg-red-100 text-red-800' }[order.status] || '';
                    allDOMElements.orderHistoryList.innerHTML += `<tr><td class="p-4 font-medium">${order.productName}</td><td class="p-4">${date}</td><td class="p-4">$${order.price.toFixed(2)}</td><td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${s}">${order.status}</span></td></tr>`;
                });
            }, () => allDOMElements.orderHistoryList.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error loading orders. A database index may be required.</td></tr>`);
        };

        allDOMElements.forgotPasswordLink.addEventListener('click', async () => {
            const email = prompt("Enter your email for a password reset link:");
            if (email) { try { await sendPasswordResetEmail(auth, email); showModal('Success', 'Password reset link sent to your email.'); } catch (err) { showModal('Error', err.message); }}
        });
        
        allDOMElements.loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, allDOMElements.loginForm.loginEmail.value, allDOMElements.loginForm.loginPassword.value); } catch (err) { showModal('Login Failed', err.message); }});
        allDOMElements.signupForm.addEventListener('submit', async e => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, allDOMElements.signupForm.signupEmail.value, allDOMElements.signupForm.signupPassword.value); } catch (err) { showModal('Signup Failed', err.message); }});
        
        allDOMElements.profileMenuButton.addEventListener('click', () => allDOMElements.profileMenu.classList.toggle('hidden'));
        allDOMElements.mobileMenuButton.addEventListener('click', () => allDOMElements.mobileMenu.classList.toggle('hidden'));
        allDOMElements.loginTab.addEventListener('click', () => { allDOMElements.signupFormContainer.classList.add('hidden'); allDOMElements.loginFormContainer.classList.remove('hidden'); allDOMElements.loginTab.classList.add('tab-active'); allDOMElements.signupTab.classList.remove('tab-active'); });
        allDOMElements.signupTab.addEventListener('click', () => { allDOMElements.loginFormContainer.classList.add('hidden'); allDOMElements.si
