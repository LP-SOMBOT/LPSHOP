<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .transition-all { transition: all 0.3s ease-in-out; }
        .transform-gpu { transform: translateZ(0); }
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <!-- Navigation Bar (no changes) -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <!-- ... all nav code is the same ... -->
    </nav>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 mt-8">
        <!-- Authentication Section (no changes) -->
        <section id="auth-section" class="max-w-md mx-auto">
            <!-- ... all auth form code is the same ... -->
        </section>

        <!-- Logged In Content Area -->
        <section id="logged-in-content" class="hidden">
            <!-- Shop Section -->
            <div id="shop-section">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-900">Our Products</h2>
                    <p class="text-gray-600 mt-2">Find the best items below</p>
                </div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <!-- Product cards will be loaded here -->
                </div>
            </div>

            <!-- NEW: My Orders Section -->
            <div id="orders-section" class="mt-20">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900">My Order History</h2>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Product</th>
                                <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Date</th>
                                <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Price</th>
                                <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Status</th>
                            </tr>
                        </thead>
                        <tbody id="order-history-list" class="divide-y divide-gray-200">
                            <!-- Order rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, addDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        const firebaseConfig = { /* ... your config ... */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM References ---
        const authSection = document.getElementById('auth-section');
        const loggedInContent = document.getElementById('logged-in-content');
        const productListDiv = document.getElementById('product-list');
        const orderHistoryList = document.getElementById('order-history-list');
        // ... other existing DOM refs

        // --- Auth State Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authSection.classList.add('hidden');
                loggedInContent.classList.remove('hidden');
                // ... existing UI updates for nav/profile
                
                fetchProducts();
                fetchUserOrders(user.uid); // Fetch orders when user logs in
            } else {
                loggedInContent.classList.add('hidden');
                authSection.classList.remove('hidden');
                // ... existing UI updates for nav/profile
            }
        });
        
        // --- NEW: Handle Buy Now Click ---
        const handleBuyNow = async (product) => {
            if (!auth.currentUser) {
                alert("Please log in to make a purchase.");
                return;
            }

            if (!confirm(`You are about to pay $${product.price} for ${product.name}.\nThis will open your phone dialer to complete the payment.\n\nDo you want to continue?`)) {
                return;
            }

            // Step 1: Create the order document in Firestore
            try {
                await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid,
                    userEmail: auth.currentUser.email,
                    productId: product.id,
                    productName: product.name,
                    price: product.price,
                    diamonds: product.diamonds,
                    imageUrl: product.imageUrl,
                    status: "Pending", // Initial status
                    orderDate: serverTimestamp()
                });
                
                // Step 2: If creation is successful, redirect to phone dialer
                const ussdCode = `*712*613982172*${product.price}#`;
                // URL encode special characters for the tel link
                const encodedUssd = encodeURIComponent(ussdCode);
                window.location.href = `tel:${encodedUssd}`;

            } catch (error) {
                console.error("Error creating order: ", error);
                alert("Could not place your order. Please try again.");
            }
        };
        
        // --- UPDATED: Fetch Products to include Buy Now logic ---
        const fetchProducts = async () => {
            // ... (rest of the function is the same)
            let productsData = []; // To store full product data
            const q = query(collection(db, "products"), orderBy("name"));
            const querySnapshot = await getDocs(q);
            
            querySnapshot.forEach((doc) => {
                const product = { ...doc.data(), id: doc.id };
                productsData.push(product);
                // ADDED data attributes to the button
                const productCard = `
                    <div class="bg-white rounded-xl ...">
                        ...
                        <button 
                            data-id="${product.id}"
                            class="buy-now-btn w-full bg-blue-600 ...">
                            Buy Now
                        </button>
                    </div>`;
                productListDiv.innerHTML += productCard;
            });
            
            // Add event listeners after cards are created
            document.querySelectorAll('.buy-now-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.id;
                    const productToBuy = productsData.find(p => p.id === productId);
                    if (productToBuy) {
                        handleBuyNow(productToBuy);
                    }
                });
            });
        };
        
        // --- NEW: Fetch User's Orders ---
        const fetchUserOrders = (userId) => {
            const ordersQuery = query(collection(db, "orders"), where("userId", "==", userId), orderBy("orderDate", "desc"));

            onSnapshot(ordersQuery, (snapshot) => {
                orderHistoryList.innerHTML = ""; // Clear list for real-time updates
                if (snapshot.empty) {
                    orderHistoryList.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">You have no orders yet.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderDate = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    let statusClass = '';
                    if (order.status === 'Pending') statusClass = 'bg-yellow-100 text-yellow-800';
                    if (order.status === 'Completed') statusClass = 'bg-green-100 text-green-800';
                    if (order.status === 'Rejected') statusClass = 'bg-red-100 text-red-800';

                    orderHistoryList.innerHTML += `
                        <tr>
                            <td class="py-3 px-4 font-medium text-gray-900">${order.productName}</td>
                            <td class="py-3 px-4 text-gray-600">${orderDate}</td>
                            <td class="py-3 px-4 text-gray-800">$${order.price.toFixed(2)}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                    ${order.status}
                                </span>
                            </td>
                        </tr>
                    `;
                });
            });
        };
        
        // ... (rest of the code for auth, nav, etc. remains the same)
    </script>
</body>
</html>
