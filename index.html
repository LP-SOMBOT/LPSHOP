        </section>

        <section id="logged-in-content" class="hidden">
            <div id="shop-section">
                <div class="text-center mb-8"><h2 class="text-4xl font-bold">Our Products</h2></div>
                <div class="mb-8 max-w-lg mx-auto"><input type="text" id="search-bar" placeholder="üîç Search for a product..." class="w-full p-3 border rounded-lg shadow-sm"></div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
            </div>
            <div id="orders-section" class="mt-20">
                <div class="text-center mb-12"><h2 class="text-3xl font-bold">My Order History</h2></div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full">
                        <thead><tr><th class="py-2 px-4 text-left">Product</th><th class="py-2 px-4 text-left">Date</th><th class="py-2 px-4 text-left">Price</th><th class="py-2 px-4 text-left">Status</th></tr></thead>
                        <tbody id="order-history-list" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div ach(btn => { const el = document.createElement('button'); el.textContent = btn.text; el.className = `text-white px-6 py-2 rounded-lg ${btn.class}`; el.onclick = btn.action; UI.modalFooter.appendChild(el); });
            UI.modal.classList.remove('hidden'); setTimeout(() => UI.modalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        const hideModal = () => { UI.modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => UI.modal.classList.add('hidden'), 300); };

        const updateNavUI = (user) => {
            const isLoggedIn = !!user;
            UI.authSection.classList.toggle('hidden', isLoggedIn); UI.loggedInContent.classList.toggle('hidden', !isLoggedIn);
            UI.authLinksDesktop.classList.toggle('hidden', isLoggedIn); UI.authLinksMobile.classList.toggle('hidden', isLoggedIn);
            UI.profileDropdownContainer.classList.toggle('hidden', !isLoggedIn); UI.profileInfoMobile.classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) UI.userEmailDisplays.forEach(el => el.textContent = user.email);
        };

        onAuthStateChanged(auth, user => {
            updateNavUI(user);
            if (user) { fetchProducts(); fetchUserOrders(user.uid); }
            else { UI.productListDiv.innerHTML = ''; productsData = []; if (unsubscribeOrders) unsubscribeOrders(); }
        });

        const handleBuyNow = (productId) => {
            const product = productsData.find(p => p.id === productId); if (!product || !auth.currentUser) return;
            showModal('Confirm Purchase', `Pay <b>$${product.price.toFixed(2)}</b> for <b>${product.name}</b>?<br>This will open your phone dialer.`,
                [{ text: 'Cancel', class: 'bg-gray-500', action: hideModal },
                 { text: 'Proceed', class: 'bg-blue-600', action: async () => {
                    hideModal();
                    try {
                        await addDoc(collection(db, "orders"), { userId: auth.currentUser.uid, userEmail: auth.currentUser.email, productId: product.id, productName: product.name, price: product.price, diamonds: product.diamonds, imageUrl: product.imageUrl, status: "Pending", orderDate: serverTimestamp() });
                        window.location.href = `tel:${encodeURIComponent(`*712*613982172*${product.price}#`)}`;
                    } catch (error) { showModal('Error', 'Could not place order.'); }
                 }}]
            );
        };
        
        const showProductDetails = (productId) => { const product = productsData.find(p => p.id === productId); if (!product) return; showModal(product.name, `<img src="${product.imageUrl}" class="w-full h-64 object-cover rounded-lg mb-4"><p>${product.description || 'No details available.'}</p>`); };

        UI.productListDiv.addEventListener('click', (e) => { const card = e.target.closest('.product-card'); if (!card) return; if (e.target.classList.contains('buy-now-btn')) handleBuyNow(card.dataset.id); else showProductDetails(card.dataset.id); });
        
        UI.searchBar.addEventListener('keyup', () => { const term = UI.searchBar.value.toLowerCase(); document.querySelectorAll('.product-card').forEach(card => card.style.display = card.dataset.name.toLowerCase().includes(term) ? '' : 'none'); });

        const fetchProducts = async () => {
            productsData = []; UI.productListDiv.innerHTML = `<p class="col-span-full text-center">Loading...</p>`;
            const q = query(collection(db, "products"), orderBy("name")); const snapshot = await getDocs(q);
            UI.productListDiv.innerHTML = '';
            if(snapshot.empty) UI.productListDiv.innerHTML = `<p class="col-span-full text-center">No products found.</p>`;
            else snapshot.forEach(doc => {
                const p = { ...doc.data(), id: doc.id }; productsData.push(p);
                UI.productListDiv.innerHTML += `
                    <div class="product-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer" data-id="${p.id}" data-name="${p.name}">
                        <img class="h-64 w-full object-cover pointer-events-none" src="${p.imageUrl}" alt="${p.name}"><div class="p-6 pointer-events-none"><h3 class="text-xl font-semibold">${p.name}</h3><p class="text-sm font-bold text-teal-500 my-2">‚ô¶Ô∏è ${p.diamonds || 0}</p><p class="text-2xl font-bold mb-4">$${p.price.toFixed(2)}</p></div>
                        <div class="p-4 pt-0"><button class="buy-now-btn w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Buy Now</button></div>
                    </div>`;
            });
        };

        const fetchUserOrders = (userId) => {
            if (unsubscribeOrders) unsubscribeOrders();
            const q = query(collection(db, "orders"), where("userId", "==", userId), orderBy("orderDate", "desc"));
            unsubscribeOrders = onSnapshot(q, (snapshot) => {
                UI.orderHistoryList.innerHTML = "";
                if (snapshot.empty) { UI.orderHistoryList.innerHTML = '<tr><td colspan="4" class="p-4 text-center">No orders yet.</td></tr>'; return; }
                snapshot.forEach(doc => {
                    const order = doc.data(); const date = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleDateString() : '...';
                    let s = { 'Pending': 'bg-yellow-100 text-yellow-800', 'Completed': 'bg-green-100 text-green-800', 'Rejected': 'bg-red-100 text-red-800' }[order.status] || '';
                    UI.orderHistoryList.innerHTML += `<tr><td class="p-4 font-medium">${order.productName}</td><td class="p-4">${date}</td><td class="p-4">$${order.price.toFixed(2)}</td><td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${s}">${order.status}</span></td></tr>`;
                });
            }, () => UI.orderHistoryList.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error loading orders. A DB index is required.</td></tr>`);
        };
        
        const toggleMusic = () => {
            if (UI.musicPlayer.paused) { UI.musicPlayer.play().catch(() => {}); UI.playIcon.classList.add('hidden'); UI.muteIcon.classList.remove('hidden'); }
            else { UI.musicPlayer.pause(); UI.muteIcon.classList.add('hidden'); UI.playIcon.classList.remove('hidden'); }
        };

        UI.forgotPasswordLink.addEventListener('click', async () => { const email = prompt("Enter email for password reset link:"); if (email) { try { await sendPasswordResetEmail(auth, email); showModal('Success', 'Password reset link sent.'); } catch (err) { showModal('Error', err.message); }} });
        UI.loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, e.target.elements.email.value, e.target.elements.password.value); } catch (err) { showModal('Login Failed', err.message); }});
        UI.signupForm.addEventListener('submit', async e => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, e.target.elements.email.value, e.target.elements.passwor
